<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Cosmos Prototype</title>
<script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
<style>
  html,body{margin:0;height:100%;background:#000;font-family:system-ui,-apple-system,Segoe UI,Roboto}
  .ui {
    position: fixed; left: 50%; top: 50%; transform: translate(-50%,-50%);
    color:#fff; text-align:center; z-index:10;
    background: rgba(0,0,0,.55); padding:16px 22px; border-radius:14px;
    width:min(92vw,520px);
  }
  .small {font-size:13px; opacity:.85; margin-top:8px}
  .hidden{display:none}
</style>
</head>
<body>

<!-- MENU UI -->
<div id="menu" class="ui">
  <h2 style="margin:.2rem 0 0.6rem">Cluster Walk</h2>
  <p style="margin:.2rem 0 .8rem; opacity:.9">A single idea cluster in a vast cosmos. Walk the path, discover connections.</p>
  <p class="small" style="margin-top:0.6rem; opacity:0.85;">
  Controls: <b>W</b> = proceed • <b>S</b> = back • <b>A/D</b> = steer
  </p>
  <div style="text-align:left; margin:.6rem auto 0; line-height:1.6">
    <div>• <b>Press W</b> — Visit existing cluster</div>
    <div>• <b>Press S</b> — Create new cluster (placeholder)</div>
  </div>
  <div class="small">Use the foil pads or keyboard.</div>
</div>

<!-- PLACEHOLDER UI FOR "CREATE NEW CLUSTER" -->
<div id="create" class="ui hidden">
  <h3 style="margin:.2rem 0 .6rem">Create New Cluster</h3>
  <p style="margin:.2rem 0 .8rem; opacity:.9">
    In the full system, this would start a new idea cluster. For this prototype, it’s a concept stub.
  </p>
  <div>• <b>Press S</b> — Back to menu</div>
</div>

<!-- DECISION UI AT THE END -->
<div id="decision" class="ui hidden">
  <h3 style="margin:.2rem 0 .6rem">Decision: What next?</h3>
  <div style="text-align:left; line-height:1.6">
    <div>• <b>Press W</b> — Continue building the cluster</div>
    <div class="small" style="margin:.4rem 0 .6rem 1.2rem">Suggested pieces (static): rec1.jpg, rec2.jpg, rec3.jpg</div>
    <div>• <b>Press S</b> — Leave cluster</div>
  </div>
</div>

<a-scene renderer="colorManagement:true" background="color:#01040c" fog="type: linear; color: #01040c; near: 8; far: 45">
  <a-entity id="stars"></a-entity>

  <!-- Camera rig -->
  <a-entity id="rig" position="0 1.6 6">
    <a-entity id="cam"
      camera
      look-controls="pointerLockEnabled: false; touchEnabled: true; magicWindowTrackingEnabled: true"
      wasd-controls="acceleration: 8">
    </a-entity>
  </a-entity>

  <a-entity id="path"></a-entity>
  <a-entity id="nodes"></a-entity>
  <a-entity id="finalNode"></a-entity>

  <a-entity light="type: ambient; intensity: 0.45"></a-entity>
  <a-entity light="type: point; intensity: 0.9; distance: 20" position="0 3 0"></a-entity>
</a-scene>

<script>
/* ---------- STATE ---------- */
let state = 'menu'; // 'menu' | 'create' | 'explore' | 'decision'

const uiMenu = document.getElementById('menu');
const uiCreate = document.getElementById('create');
const uiDecision = document.getElementById('decision');

function setState(next) {
  state = next;
  uiMenu.classList.toggle('hidden', state !== 'menu');
  uiCreate.classList.toggle('hidden', state !== 'create');
  uiDecision.classList.toggle('hidden', state !== 'decision');
  const c = document.querySelector('a-scene').canvas;
  if (c) c.focus();
}

window.addEventListener('keydown', (e) => {
  const k = e.key.toLowerCase();
  if (state === 'menu') {
    if (k === 'w') startExplore();
    if (k === 's') setState('create');
  } else if (state === 'create') {
    if (k === 's') setState('menu');
  } else if (state === 'decision') {
    if (k === 'w') alert('Recommendations (static stub): rec1.jpg, rec2.jpg, rec3.jpg');
    if (k === 's') fadeAndReload(); // smoother exit
  }
});

document.addEventListener('touchend', () => {
  const c = document.querySelector('a-scene')?.canvas; if (c) c.focus();
});

/* ---------- BUILD SCENE ---------- */
const TOTAL_NODES = 12;
const RADIUS = 6;
const ART_REVEAL_DIST = 2.2;

const nodesEl = document.getElementById('nodes');
const pathEl  = document.getElementById('path');
const finalEl = document.getElementById('finalNode');

(function buildStars(){
  const stars = document.getElementById('stars');
  for (let i=0;i<200;i++){
    const s = document.createElement('a-sphere');
    const r = 30 + Math.random()*30;
    const theta = Math.random()*Math.PI*2, phi = Math.acos(2*Math.random()-1);
    const x = r*Math.sin(phi)*Math.cos(theta);
    const y = r*Math.cos(phi);
    const z = r*Math.sin(phi)*Math.sin(theta);
    s.setAttribute('position', `${x} ${y} ${z}`);
    s.setAttribute('radius', 0.02);
    s.setAttribute('material', 'color:#98a; emissive:#98a; emissiveIntensity:0.9; opacity:0.85; transparent:true');
    stars.appendChild(s);
  }
})();

/* ---------- Ground ribbon path ---------- */
const PATH_WIDTH = 0.45;
const PATH_HEIGHT_OFFSET = 0.02;
const PATH_EMISSIVE = '#6dd';
const PATH_OPACITY = 0.30;
const PATH_EMISSIVE_INT = 0.22;

function buildSCurve() {
  const pts = [
    {x:-4, y:0, z:6},
    {x:-1.5, y:0, z:2.5},
    {x:1.5, y:0, z:-1.0},
    {x:4.0, y:0, z:-4.5},
    {x:6.5, y:0, z:-8.0},
  ];

  while (pathEl.firstChild) pathEl.removeChild(pathEl.firstChild);

  for (let i = 0; i < pts.length - 1; i++) {
    const a = pts[i], b = pts[i+1];
    const dx = b.x - a.x, dz = b.z - a.z, dy = b.y - a.y;
    const len = Math.sqrt(dx*dx + dy*dy + dz*dz);
    const mid = { x:(a.x+b.x)/2, y:(a.y+b.y)/2 + PATH_HEIGHT_OFFSET, z:(a.z+b.z)/2 };
    const yawDeg = Math.atan2(dx, dz) * 180/Math.PI;

    const seg = document.createElement('a-plane');
    seg.setAttribute('position', `${mid.x} ${mid.y} ${mid.z}`);
    seg.setAttribute('rotation', `-90 ${yawDeg} 0`);
    seg.setAttribute('width', PATH_WIDTH);
    seg.setAttribute('height', len.toFixed(3));
    seg.setAttribute('material', `
      color: ${PATH_EMISSIVE};
      emissive: ${PATH_EMISSIVE};
      emissiveIntensity: ${PATH_EMISSIVE_INT};
      opacity: ${PATH_OPACITY};
      transparent: true;
      side: double;
    `);
    pathEl.appendChild(seg);
  }
  return pts[pts.length - 1];
}

/* ---------- Nodes ---------- */
function buildNodes() {
  const center = {x:1.2, y:1.2, z:-1.2};
  const artIdx = new Set([2,5,8,11]);
  for (let i=0;i<12;i++){
    const rr = RADIUS*(0.4 + Math.random()*0.6);
    const ang = Math.random()*Math.PI*2;
    const h = (Math.random()*1.2) - 0.6;
    const px = center.x + Math.cos(ang)*rr*0.4 + (Math.random()*1.2-0.6);
    const py = 1.2 + h;
    const pz = center.z + Math.sin(ang)*rr*0.7 + (Math.random()*1.2-0.6);

    const node = document.createElement('a-entity');
    node.setAttribute('position', `${px.toFixed(2)} ${py.toFixed(2)} ${pz.toFixed(2)}`);

    const dot = document.createElement('a-sphere');
    dot.setAttribute('radius', artIdx.has(i)? 0.13 : 0.08);
    dot.setAttribute('material', `color:#8cf; emissive:#8cf; emissiveIntensity:${artIdx.has(i)?'0.85':'0.55'}; opacity:${artIdx.has(i)?'0.95':'0.8'}; transparent:true`);
    node.appendChild(dot);

    if (artIdx.has(i)) {
      const plane = document.createElement('a-plane');
      plane.setAttribute('width','1.0'); plane.setAttribute('height','1.4');
      plane.setAttribute('position','0 0 -0.01');
      plane.setAttribute('rotation','0 0 0');
      plane.setAttribute('material','color:#ffffff; opacity:0; transparent:true');
      plane.classList.add('art');
      node.appendChild(plane);
    }
    nodesEl.appendChild(node);
  }
}

/* ---------- Reveal-on-approach ---------- */
AFRAME.registerComponent('art-revealer', {
  init() {
    this.cam = document.getElementById('cam');
    this.arts = Array.from(document.querySelectorAll('#nodes .art'));
    this._camWorld = new THREE.Vector3();
    this._artWorld = new THREE.Vector3();
  },
  tick() {
    if (!this.cam) return;
    this.cam.object3D.getWorldPosition(this._camWorld);
    this.arts.forEach(p=>{
      p.object3D.getWorldPosition(this._artWorld);
      const d = this._camWorld.distanceTo(this._artWorld);
      const t = Math.min(1, Math.max(0, 1 - (d/ART_REVEAL_DIST)));
      const opacity = 0.05 + t*0.95;
      p.setAttribute('material', `color:#fff; opacity:${opacity}; transparent:true`);
    });
  }
});

/* ---------- Final node ---------- */
function buildFinalNode(anchor){
  const root = document.createElement('a-entity');
  const pos = `${anchor.x} 1.3 ${anchor.z}`;
  root.setAttribute('position', pos);

  const core = document.createElement('a-sphere');
  core.setAttribute('radius','0.22');
  core.setAttribute('material','color:#ffd580; emissive:#ffd580; emissiveIntensity:0.95; opacity:0.98; transparent:true');
  root.appendChild(core);

  for (let i=0;i<5;i++){
    const sat = document.createElement('a-sphere');
    sat.setAttribute('radius','0.06');
    sat.setAttribute('material','color:#fff; emissive:#fff; emissiveIntensity:0.8; opacity:0.9; transparent:true');
    const orbit = document.createElement('a-entity');
    const r = 0.7 + Math.random()*0.5;
    const speed = 3000 + Math.random()*2000;
    orbit.setAttribute('position','0 0 0');
    sat.setAttribute('position', `${r} 0 0`);
    orbit.appendChild(sat);
    orbit.setAttribute('animation', `property: rotation; to: 0 360 0; dur: ${speed}; easing: linear; loop: true`);
    root.appendChild(orbit);
  }

  root.setAttribute('final-proximity','');
  finalEl.appendChild(root);
}

/* ---------- Fixed world-space proximity ---------- */
AFRAME.registerComponent('final-proximity', {
  init(){
    this.cam = document.getElementById('cam');
    this.shown=false;
    this._camWorld = new THREE.Vector3();
    this._hereWorld = new THREE.Vector3();
  },
  tick(){
    if (!this.cam) return;
    this.cam.object3D.getWorldPosition(this._camWorld);
    this.el.object3D.getWorldPosition(this._hereWorld);
    const d = this._camWorld.distanceTo(this._hereWorld);
    if (d < 2.8 && !this.shown){
      this.shown = true;
      setState('decision');
    }
    if (d >= 3.2 && this.shown){
      this.shown = false;
      if (state==='decision') setState('explore');
    }
  }
});

/* ---------- Utilities ---------- */
function resetPlayer(){
  const rig = document.getElementById('rig');
  rig.setAttribute('position','0 1.6 6');
  rig.object3D.rotation.set(0,0,0);
}

// Smooth fade to black with text, then reload
function fadeAndReload() {
  const overlay = document.createElement('div');
  overlay.style.position = 'fixed';
  overlay.style.left = 0;
  overlay.style.top = 0;
  overlay.style.width = '100vw';
  overlay.style.height = '100vh';
  overlay.style.background = '#000';
  overlay.style.opacity = '0';
  overlay.style.transition = 'opacity 1.8s ease';
  overlay.style.zIndex = '999';
  overlay.style.display = 'flex';
  overlay.style.alignItems = 'center';
  overlay.style.justifyContent = 'center';
  overlay.style.flexDirection = 'column';
  document.body.appendChild(overlay);

  const text = document.createElement('div');
  text.textContent = 'Leaving cluster…';
  text.style.color = '#fff';
  text.style.fontSize = '1.6rem';
  text.style.opacity = '0.85';
  text.style.fontFamily = 'system-ui, -apple-system, Segoe UI, Roboto, sans-serif';
  text.style.letterSpacing = '0.06em';
  overlay.appendChild(text);

  requestAnimationFrame(() => { overlay.style.opacity = '1'; });
  setTimeout(() => { location.reload(); }, 2200);
}

/* ---------- Start ---------- */
let built = false;
function startExplore(){
  setState('explore');
  if (!built){
    const last = buildSCurve();
    buildNodes();
    buildFinalNode(last);
    document.querySelector('a-scene').setAttribute('art-revealer','');
    built = true;
  }
  resetPlayer();
}


setState('menu');
</script>
</body>
</html>
